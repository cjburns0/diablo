<html lang="en"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mount Diablo Challenge Analytics</title>
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" type="image/png" href="assets/logo.png">
  <link rel="apple-touch-icon" href="assets/logo.png">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- UploadThingy Widget -->
  <script>window.UPLOADTHINGY_API_URL = 'https://app.uploadthingy.com';</script>
  <script src="https://app.uploadthingy.com/static/js/uploadthingy-widget.js"></script>
</head>
<body class="antialiased selection:bg-slate-900 selection:text-white bg-black text-slate-100" style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;">
  <!-- App Shell -->
  <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/60 border-b bg-black/90 border-slate-800">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="assets/logo.png" alt="Mt. Diablo Challenge Logo" class="h-10 w-10 rounded-md">
        <div class="text-[20px] sm:text-[22px] font-semibold tracking-tight whitespace-nowrap">Mt. Diablo Challenge</div>
        <!-- Navigation links - commented out for future use
        <div class="hidden md:flex items-center gap-6 pl-6 ml-4 border-l border-slate-800">
          <a href="#overview" class="text-sm font-medium text-slate-400 hover:text-slate-100">Overview</a>
          <a href="#trends" class="text-sm font-medium text-slate-400 hover:text-slate-100">Trends</a>
          <a href="#weather" class="text-sm font-medium text-slate-400 hover:text-slate-100">Weather Impact</a>
        </div>
        -->
      </div>
      <div class="flex items-center gap-3">
        <button id="uploadButton" class="inline-flex items-center gap-1.5 text-sm font-medium border rounded-md px-3 py-1.5 text-slate-100 border-sky-700 bg-sky-900 hover:bg-sky-800">
          <i data-lucide="upload" class="w-4 h-4 text-sky-400"></i>
          Send Files Here
        </button>
        <div class="hidden sm:flex items-center px-2.5 py-1.5 border rounded-md shadow-sm/50 border-slate-700 bg-slate-900 opacity-50 cursor-not-allowed">
          <i data-lucide="search" class="w-4 h-4 text-slate-500"></i>
          <input type="text" placeholder="Search races, years, riders…" class="ml-2 text-sm placeholder:text-slate-500 focus:outline-none bg-transparent w-64 cursor-not-allowed" disabled>
        </div>
        <!-- Export button - commented out for future use
        <button class="inline-flex items-center gap-1.5 text-sm font-medium border rounded-md px-2.5 py-1.5 text-slate-300 border-slate-800 hover:bg-slate-950">
          <i data-lucide="download" class="w-4 h-4 text-slate-400"></i>
          Export
        </button>
        -->
      </div>
    </div>
  </header>

  <!-- Upload Modal -->
  <div id="uploadModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="relative w-full max-w-2xl mx-4 rounded-xl border shadow-xl border-slate-800 bg-black p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-slate-100">Upload Files</h2>
        <button id="closeModal" class="text-slate-400 hover:text-slate-100">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <!-- UploadThingy Widget -->
      <div id="uploadthingy-widget" data-domain="diablochallenge.com"></div>
    </div>
  </div>

  <!-- Main -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <!-- Heading + KPI -->
    <section class="mb-8">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
        <div>
          <h1 class="text-[28px] md:text-[32px] font-semibold tracking-tight text-slate-100">Mount Diablo Challenge Analytics</h1>
          <p class="text-sm md:text-base mt-1 text-slate-400">11.2-mile climbing time trial with 3,249 ft elevation gain. Compare finish times across years and analyze wind's impact on performance.</p>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 w-full md:w-auto">
          <div class="rounded-lg border p-3 shadow-sm hover:shadow transition border-slate-800 bg-black">
            <div class="text-[11px] uppercase tracking-wide text-slate-500">Fastest Year</div>
            <div class="mt-1 flex items-baseline gap-2">
              <div class="text-xl font-semibold tabular-nums" id="kpi-fastest-year">Loading...</div>
              <div class="text-xs text-emerald-400" id="kpi-fastest-pct">—</div>
            </div>
          </div>
          <div class="rounded-lg border p-3 shadow-sm hover:shadow transition border-slate-800 bg-black">
            <div class="flex items-center gap-1.5 text-[11px] uppercase tracking-wide text-slate-500">
              <span>Wind Impact</span>
              <div class="relative group">
                <i data-lucide="info" class="w-3 h-3 text-slate-500 cursor-help"></i>
                <div class="absolute left-0 top-5 hidden group-hover:block w-56 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs normal-case tracking-normal shadow-lg z-50">
                  <div class="text-slate-200 font-normal">Correlation coefficient (r) shows the relationship between wind speed and finish times. Negative values mean higher wind is associated with slower times. r = -0.45 indicates 45% correlation strength.</div>
                </div>
              </div>
            </div>
            <div class="mt-1 flex items-baseline gap-2">
              <div class="text-xl font-semibold tabular-nums" id="kpi-wind-corr">r = —</div>
              <div class="text-xs text-slate-500">Lower wind → faster</div>
            </div>
          </div>
          <div class="rounded-lg border p-3 shadow hover:shadow transition border-slate-800 bg-black">
            <div class="text-[11px] uppercase tracking-wide text-slate-500">Median Time</div>
            <div class="mt-1 flex items-baseline gap-2">
              <div class="text-xl font-semibold tabular-nums" id="kpi-median-time">—</div>
              <div class="text-xs text-slate-500" id="kpi-fastest-time">Fastest: —</div>
            </div>
          </div>
          <div class="rounded-lg border p-3 shadow-sm hover:shadow transition border-slate-800 bg-black">
            <div class="text-[11px] uppercase tracking-wide text-slate-500">Sample Size</div>
            <div class="mt-1 flex items-baseline gap-2">
              <div class="text-xl font-semibold tabular-nums" id="kpi-total-years">— yrs</div>
              <div class="text-xs text-slate-500" id="kpi-year-range">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Main Chart -->
    <section class="mb-6">
      <!-- Main Chart Card -->
      <div class="rounded-xl border shadow-sm border-slate-800 bg-black">
        <div class="flex items-center justify-between px-4 sm:px-5 py-3 border-b border-slate-800">
          <div class="flex items-center gap-2">
            <i data-lucide="line-chart" class="w-4 h-4 text-slate-400"></i>
            <div class="text-sm font-medium text-slate-200">Finish Time by Year</div>
          </div>
          <div class="flex items-center gap-2">
            <div class="flex items-center gap-1 rounded-md border p-1 border-slate-800">
              <button id="toggle-wind" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium rounded text-slate-300 hover:bg-slate-950 bg-sky-900" aria-pressed="true">
                <i data-lucide="wind" class="w-3.5 h-3.5 text-sky-400"></i> Wind Overlay
              </button>
              <div class="relative group px-1">
                <i data-lucide="info" class="w-3.5 h-3.5 text-slate-500 cursor-help"></i>
                <div class="absolute right-0 top-8 hidden group-hover:block w-72 bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-xs shadow-xl z-50">
                  <div class="flex items-start gap-2">
                    <i data-lucide="lightbulb" class="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5"></i>
                    <div>
                      <div class="font-medium text-slate-200 mb-1">About Wind Impact</div>
                      <p class="text-slate-400">Wind is the primary weather factor affecting climb times. The summit is particularly exposed to wind, which can add significant time to finishes. Toggle overlay to see correlation with performance.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="p-4 sm:p-6">
          <!-- Responsive Chart Wrapper -->
          <div class="relative">
            <div class="w-full rounded-lg ring-1 overflow-hidden ring-slate-800 bg-black relative">
              <!-- SVG Chart -->
              <svg id="main-chart" viewBox="0 0 960 550" class="w-full h-[550px]">
                <!-- Chart will be dynamically generated by JavaScript -->
              </svg>
              <!-- Tooltip -->
              <div id="chart-tooltip" class="absolute hidden bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs shadow-lg pointer-events-none z-50">
                <div id="tooltip-content" class="text-slate-200"></div>
              </div>
            </div>

            <!-- Legend -->
            <div class="mt-4 space-y-3">
              <!-- Legend Items -->
              <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2.5 text-xs text-slate-400">
                <div class="flex items-center gap-2">
                  <span class="h-2 w-2 rounded-full flex-shrink-0" style="background-color:#ef4444;"></span>
                  <span><strong class="text-slate-300">Fastest time</strong> - Best finish that year</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="h-2 w-2 rounded-full flex-shrink-0" style="background-color:#eab308;"></span>
                  <span><strong class="text-slate-300">10th percentile</strong> - Top 10% of finishers</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="h-3 w-4 rounded-sm border flex-shrink-0" style="border-color:#64748b; background-color:rgba(148,163,184,0.08)"></span>
                  <span><strong class="text-slate-300">Box (IQR)</strong> - 25th to 75th percentile</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="h-2 w-2 rounded-full flex-shrink-0" style="background-color:#6366f1;"></span>
                  <span><strong class="text-slate-300">Mean</strong> - Average finish time</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="flex-shrink-0" style="color:#fbbf24; font-size:14px;">★</span>
                  <span><strong class="text-slate-300">Gold stars</strong> - Multi-year riders</span>
                </div>
              </div>

              <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2.5 text-xs text-slate-400">
                <div class="flex items-center gap-2">
                  <span class="h-1.5 w-5 rounded-full flex-shrink-0" style="background-color:#0f766e;"></span>
                  <span><strong class="text-slate-300">Median line</strong> - 50th percentile trend</span>
                </div>
                <div class="flex items-center gap-1.5">
                  <span class="text-slate-300 font-medium">Wind overlay:</span>
                  <span class="h-3 w-4 rounded-sm flex-shrink-0" style="background-color:rgba(34, 197, 94, 0.25);"></span>
                  <span class="text-slate-400 text-xs">Tailwind</span>
                  <span class="h-3 w-4 rounded-sm flex-shrink-0" style="background-color:rgba(251, 191, 36, 0.25);"></span>
                  <span class="text-slate-400 text-xs">Crosswind</span>
                  <span class="h-3 w-4 rounded-sm flex-shrink-0" style="background-color:rgba(239, 68, 68, 0.25);"></span>
                  <span class="text-slate-400 text-xs">Headwind</span>
                </div>
                <div class="flex items-center gap-2">
                  <i data-lucide="info" class="w-3.5 h-3.5 text-slate-500 flex-shrink-0"></i>
                  <span class="text-slate-500">Y-axis inverted: faster times at top, slower at bottom</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Row 1: Rider Lookup | Course Direction | Wind Impact -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <!-- Rider Lookup -->
      <div class="rounded-xl border shadow-sm border-slate-800 bg-black">
        <div class="px-4 sm:px-5 py-3 border-b border-slate-800">
          <div class="flex items-center gap-2">
            <i data-lucide="user-search" class="w-4 h-4 text-slate-400"></i>
            <div class="text-sm font-medium text-slate-200">Rider Lookup</div>
          </div>
        </div>
        <div class="p-4 sm:p-5">
          <div class="relative">
            <input
              type="text"
              id="riderSearch"
              placeholder="Search for a rider..."
              class="w-full px-3 py-2 text-sm rounded-md border bg-black text-slate-200 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-sky-500 border-slate-800"
              autocomplete="off"
            />
            <div id="riderSearchResults" class="hidden absolute z-30 mt-1 w-full rounded-md border shadow-lg overflow-hidden border-slate-800 bg-black max-h-60 overflow-auto">
              <!-- Populated by JavaScript -->
            </div>
          </div>
          <p class="text-xs text-slate-500 mt-2">Search for riders with multiple years to compare year-over-year performance.</p>
        </div>
      </div>

      <!-- Course Direction -->
      <div class="rounded-xl border shadow-sm border-slate-800 bg-black">
        <div class="px-4 sm:px-5 py-3 border-b border-slate-800">
          <div class="flex items-center gap-2">
            <i data-lucide="compass" class="w-4 h-4 text-sky-400"></i>
            <div class="text-sm font-medium text-slate-200">Course Direction</div>
          </div>
        </div>
        <div class="p-4 sm:p-5 flex items-center justify-center">
          <div id="routeCompass" class="text-xs text-slate-500">
            Loading route data...
          </div>
        </div>
      </div>

      <!-- Wind Impact -->
      <div class="rounded-xl border shadow-sm border-slate-800 bg-black">
        <div class="px-4 sm:px-5 py-3 border-b border-slate-800">
          <div class="flex items-center gap-2">
            <i data-lucide="wind" class="w-4 h-4 text-sky-400"></i>
            <div class="text-sm font-medium text-slate-200">Wind Impact</div>
          </div>
        </div>
        <div class="p-4 sm:p-5">
          <div id="windBenefitBox" class="text-xs text-slate-500">
            Loading wind analysis...
          </div>
        </div>
      </div>
    </section>

    <!-- Row 2: Year Filters | YoY Delta | Performance Outliers -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Year Filters -->
      <div class="rounded-xl border shadow-sm border-slate-800 bg-black">
        <div class="px-4 sm:px-5 py-3 border-b flex items-center justify-between border-slate-800">
          <div class="flex items-center gap-2">
            <i data-lucide="sliders" class="w-4 h-4 text-slate-400"></i>
            <div class="text-sm font-medium text-slate-200">Year Filters</div>
          </div>
          <button id="resetFilters" class="text-xs font-medium text-slate-400 hover:text-slate-100">Reset</button>
        </div>
        <div class="p-4 sm:p-5 space-y-3">
          <!-- Years -->
          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1.5">
              <label class="text-xs font-medium text-slate-400">Start Year</label>
              <div class="relative">
                <button data-popover-button="#startYearMenu" class="w-full flex items-center justify-between px-3 py-2 rounded-md border text-sm border-slate-800 bg-black hover:bg-slate-950">
                  <span class="text-slate-200" id="startYearValue">2010</span>
                  <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500"></i>
                </button>
                <div id="startYearMenu" data-popover="" class="hidden absolute z-20 mt-1 w-full rounded-md border shadow-md overflow-hidden border-slate-800 bg-black">
                  <ul class="max-h-60 overflow-auto py-1" id="startYearList"></ul>
                </div>
              </div>
            </div>
            <div class="space-y-1.5">
              <label class="text-xs font-medium text-slate-400">End Year</label>
              <div class="relative">
                <button data-popover-button="#endYearMenu" class="w-full flex items-center justify-between px-3 py-2 rounded-md border text-sm border-slate-800 bg-black hover:bg-slate-950">
                  <span class="text-slate-200" id="endYearValue">2024</span>
                  <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500"></i>
                </button>
                <div id="endYearMenu" data-popover="" class="hidden absolute z-20 mt-1 w-full rounded-md border shadow-md overflow-hidden border-slate-800 bg-black">
                  <ul class="max-h-60 overflow-auto py-1" id="endYearList"></ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Apply -->
          <button id="applyFilters" class="w-full inline-flex items-center justify-center gap-2 rounded-md border px-3 py-2 text-sm font-medium border-slate-700 bg-black text-slate-200 hover:bg-slate-950">
            <i data-lucide="refresh-cw" class="w-4 h-4 text-slate-300"></i>
            Apply filters
          </button>

          <!-- Wind Correlation -->
          <div class="pt-2 border-t border-slate-800">
            <div class="flex items-center justify-between text-xs">
              <span class="text-slate-500">Wind Correlation</span>
              <span class="font-medium tabular-nums text-slate-300" id="filter-wind-corr">—</span>
            </div>
          </div>
        </div>
      </div>

      <!-- YoY Delta -->
      <div class="rounded-xl border shadow-sm border-slate-800 bg-black">
        <div class="px-4 sm:px-5 py-3 border-b border-slate-800">
          <div class="flex items-center gap-2">
            <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
            <div class="text-sm font-medium text-slate-200">Year-over-Year Delta</div>
          </div>
        </div>
        <div class="p-4 sm:p-5 space-y-2">
          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-400">Last year vs prior</span>
            <span class="font-medium tabular-nums" id="yoy-last-year">—</span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-400">Average annual change</span>
            <span class="font-medium tabular-nums text-slate-200" id="yoy-avg-change">—</span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-slate-400">Volatility (std dev)</span>
            <span class="font-medium tabular-nums text-slate-200" id="yoy-volatility">—</span>
          </div>
        </div>
      </div>

      <!-- Performance Outliers -->
      <div class="rounded-xl border shadow-sm border-slate-800 bg-black">
        <div class="px-4 sm:px-5 py-3 border-b border-slate-800">
          <div class="flex items-center gap-2">
            <i data-lucide="target" class="w-4 h-4 text-slate-400"></i>
            <div class="text-sm font-medium text-slate-200">Performance Outliers</div>
            <div class="relative group">
              <i data-lucide="info" class="w-3.5 h-3.5 text-slate-500 cursor-help"></i>
              <div class="absolute left-0 top-6 hidden group-hover:block w-64 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-xs shadow-lg z-50">
                <div class="text-slate-200">Years shown are based on % difference from overall median time (77:03)</div>
              </div>
            </div>
          </div>
        </div>
        <div class="p-4 sm:p-5">
          <ul id="outliers-list" class="divide-y divide-slate-800">
            <!-- Populated by JavaScript -->
          </ul>
        </div>
      </div>
    </section>
  </main>

  <!-- Feedback Modal -->
  <div id="feedbackModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="relative w-full max-w-md mx-4 rounded-xl border shadow-xl border-slate-800 bg-black p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-slate-100">Send Feedback</h2>
        <button id="closeFeedbackModal" class="text-slate-400 hover:text-slate-100">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <p class="text-slate-300 text-sm mb-4">We'd love to hear from you! Please send your feedback, questions, or suggestions via email.</p>
      <div class="flex items-center gap-2 p-3 rounded-lg bg-slate-900 border border-slate-700">
        <i data-lucide="mail" class="w-5 h-5 text-sky-400 flex-shrink-0"></i>
        <span class="text-slate-200 font-medium">Colin at ThirdSouth.capital</span>
      </div>
    </div>
  </div>

  <!-- Rider Performance Modal -->
  <div id="riderModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="relative w-full max-w-3xl mx-4 rounded-xl border shadow-xl border-slate-800 bg-black p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <span class="text-amber-400 text-xl">★</span>
          <h2 class="text-xl font-semibold text-slate-100" id="riderModalName">Rider Performance</h2>
        </div>
        <button id="closeRiderModal" class="text-slate-400 hover:text-slate-100">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div id="riderModalContent" class="space-y-4">
        <!-- Populated by JavaScript -->
      </div>
    </div>
  </div>

  <footer class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
    <div class="border-t pt-6 flex flex-col sm:flex-row items-center justify-between gap-3 border-slate-800">
      <div class="flex items-center gap-2 text-sm">
        <span class="text-slate-500">© <span class="tabular-nums">2025</span> VELODATA</span>
        <span class="text-slate-700">•</span>
        <span class="text-slate-500">Created by CJB</span>
      </div>
      <div class="flex items-center gap-4 text-sm">
        <button id="feedbackButton" class="text-slate-400 hover:text-slate-100 cursor-pointer">Feedback</button>
      </div>
    </div>
  </footer>

  <!-- Data and Chart Interactions -->
  <script>
    // Dashboard data (loaded from JSON)
    let dashboardData = null;
    let routeData = null; // GPX route data
    let selectedRider = null; // Currently selected rider

    // Geospatial utility functions
    function toRadians(degrees) {
      return degrees * Math.PI / 180;
    }

    function toDegrees(radians) {
      return radians * 180 / Math.PI;
    }

    // Calculate distance between two points using Haversine formula (returns meters)
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth radius in meters
      const φ1 = toRadians(lat1);
      const φ2 = toRadians(lat2);
      const Δφ = toRadians(lat2 - lat1);
      const Δλ = toRadians(lon2 - lon1);

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c; // Distance in meters
    }

    // Calculate bearing between two points (returns degrees 0-360)
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const φ1 = toRadians(lat1);
      const φ2 = toRadians(lat2);
      const Δλ = toRadians(lon2 - lon1);

      const y = Math.sin(Δλ) * Math.cos(φ2);
      const x = Math.cos(φ1) * Math.sin(φ2) -
                Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
      const θ = Math.atan2(y, x);

      return (toDegrees(θ) + 360) % 360; // Normalize to 0-360
    }

    // Convert bearing to 16-direction compass (N, NNE, NE, etc.)
    function bearingToDirection(bearing) {
      const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
      const index = Math.round(bearing / 22.5) % 16;
      return directions[index];
    }

    // Parse GPX file and calculate route directional distribution
    async function fetchAndParseGPX() {
      try {
        const response = await fetch('data/Diablo%20Standard%20Uphill%20Only.gpx');
        if (!response.ok) {
          console.warn('GPX file not found. Wind directionality features will be disabled.');
          return null;
        }

        const gpxText = await response.text();
        const parser = new DOMParser();
        const gpxDoc = parser.parseFromString(gpxText, 'text/xml');

        // Extract track points
        const trkpts = gpxDoc.querySelectorAll('trkpt');
        if (trkpts.length === 0) {
          console.warn('No track points found in GPX file.');
          return null;
        }

        const points = Array.from(trkpts).map(pt => ({
          lat: parseFloat(pt.getAttribute('lat')),
          lon: parseFloat(pt.getAttribute('lon'))
        }));

        console.log(`Parsed ${points.length} GPS points from route`);

        // Calculate distance traveled in each direction
        const directionDistances = {};
        const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        directions.forEach(dir => directionDistances[dir] = 0);

        let totalDistance = 0;

        for (let i = 0; i < points.length - 1; i++) {
          const p1 = points[i];
          const p2 = points[i + 1];

          const distance = haversineDistance(p1.lat, p1.lon, p2.lat, p2.lon);
          const bearing = calculateBearing(p1.lat, p1.lon, p2.lat, p2.lon);
          const direction = bearingToDirection(bearing);

          directionDistances[direction] += distance;
          totalDistance += distance;
        }

        // Convert to percentages
        const directionPercentages = {};
        directions.forEach(dir => {
          directionPercentages[dir] = (directionDistances[dir] / totalDistance) * 100;
        });

        console.log('Route directional distribution:', directionPercentages);

        return {
          points: points,
          directionDistances: directionDistances,
          directionPercentages: directionPercentages,
          totalDistance: totalDistance,
          primaryDirection: Object.keys(directionPercentages).reduce((a, b) =>
            directionPercentages[a] > directionPercentages[b] ? a : b
          )
        };
      } catch (error) {
        console.error('Error parsing GPX file:', error);
        return null;
      }
    }

    // Calculate wind benefit for a given wind direction based on route
    function calculateWindImpact(windDirection, routeData) {
      if (!routeData || !routeData.directionPercentages) return { impact: 'neutral', score: 0 };

      // Calculate component of wind in each travel direction
      let totalBenefit = 0;

      Object.keys(routeData.directionPercentages).forEach(travelDir => {
        const travelBearing = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'].indexOf(travelDir) * 22.5;
        const travelPct = routeData.directionPercentages[travelDir];

        // Calculate angle difference (tailwind is 180° behind travel direction)
        let angleDiff = Math.abs(windDirection - travelBearing);
        if (angleDiff > 180) angleDiff = 360 - angleDiff;

        // Tailwind component: cos(angleDiff) where 0° = headwind, 180° = tailwind
        const tailwindComponent = -Math.cos(toRadians(angleDiff));

        // Weight by distance traveled in this direction
        totalBenefit += tailwindComponent * travelPct;
      });

      // Normalize score (-1 = pure headwind, +1 = pure tailwind)
      const normalizedScore = totalBenefit / 100;

      let impact;
      if (normalizedScore < -0.3) impact = 'detrimental';
      else if (normalizedScore > 0.3) impact = 'beneficial';
      else impact = 'neutral';

      return { impact, score: normalizedScore };
    }

    // Render route direction compass
    function renderRouteCompass() {
      const compass = document.getElementById('routeCompass');

      if (!routeData) {
        compass.innerHTML = '<div class="text-slate-500">Route data not available</div>';
        return;
      }

      const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
      const size = 200;
      const center = size / 2;
      const maxRadius = center - 20;

      let svg = `<svg viewBox="0 0 ${size} ${size}" class="w-48 h-48">`;

      // Background circle
      svg += `<circle cx="${center}" cy="${center}" r="${maxRadius}" fill="none" stroke="#334155" stroke-width="1"/>`;

      // Direction segments
      directions.forEach((dir, i) => {
        const angle = i * 22.5;
        const pct = routeData.directionPercentages[dir];
        const radius = (pct / Math.max(...Object.values(routeData.directionPercentages))) * maxRadius;

        if (radius > 0) {
          const startAngle = angle - 11.25;
          const endAngle = angle + 11.25;

          // Create pie slice
          const x1 = center + radius * Math.sin(toRadians(startAngle));
          const y1 = center - radius * Math.cos(toRadians(startAngle));
          const x2 = center + radius * Math.sin(toRadians(endAngle));
          const y2 = center - radius * Math.cos(toRadians(endAngle));

          const largeArc = 0;

          svg += `<path d="M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="#0ea5e9" fill-opacity="${0.3 + (pct / 100)}" stroke="#0ea5e9" stroke-width="1"/>`;
        }
      });

      // Cardinal direction labels
      const labelRadius = maxRadius + 10;
      [
        {dir: 'N', angle: 0},
        {dir: 'E', angle: 90},
        {dir: 'S', angle: 180},
        {dir: 'W', angle: 270}
      ].forEach(({dir, angle}) => {
        const x = center + labelRadius * Math.sin(toRadians(angle));
        const y = center - labelRadius * Math.cos(toRadians(angle)) + 4;
        svg += `<text x="${x}" y="${y}" text-anchor="middle" class="fill-slate-400 text-[10px] font-medium">${dir}</text>`;
      });

      // Center dot
      svg += `<circle cx="${center}" cy="${center}" r="3" fill="#0ea5e9"/>`;

      svg += '</svg>';
      svg += `<div class="mt-2 text-center text-xs text-slate-500">Primary direction: <span class="text-sky-400 font-medium">${routeData.primaryDirection}</span></div>`;

      compass.innerHTML = svg;
    }

    // Render wind benefit/detriment box
    function renderWindBenefitBox() {
      const box = document.getElementById('windBenefitBox');

      if (!routeData) {
        box.innerHTML = '<div class="text-slate-500">Route data required for analysis</div>';
        return;
      }

      // Analyze wind directions
      const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
      const beneficial = [];
      const detrimental = [];
      const neutral = [];

      directions.forEach((dir, i) => {
        const bearing = i * 22.5;
        const impact = calculateWindImpact(bearing, routeData);

        if (impact.impact === 'beneficial') beneficial.push(dir);
        else if (impact.impact === 'detrimental') detrimental.push(dir);
        else neutral.push(dir);
      });

      let html = '<div class="space-y-2">';

      if (beneficial.length > 0) {
        html += `
          <div class="flex items-start gap-2">
            <div class="px-2 py-0.5 rounded text-xs font-medium bg-emerald-900/30 text-emerald-400 whitespace-nowrap">Beneficial</div>
            <div class="text-slate-400 text-xs">${beneficial.join(', ')}</div>
          </div>
        `;
      }

      if (detrimental.length > 0) {
        html += `
          <div class="flex items-start gap-2">
            <div class="px-2 py-0.5 rounded text-xs font-medium bg-rose-900/30 text-rose-400 whitespace-nowrap">Detrimental</div>
            <div class="text-slate-400 text-xs">${detrimental.join(', ')}</div>
          </div>
        `;
      }

      html += '</div>';
      box.innerHTML = html;
    }

    // Fetch dashboard data from JSON file
    async function fetchDashboardData() {
      try {
        const response = await fetch('data/dashboard_data.json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        dashboardData = await response.json();
        console.log('Dashboard data loaded successfully');
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        // Show error message to user
        document.body.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #000; color: #ef4444; font-family: Inter, sans-serif;">
            <div style="text-align: center;">
              <h1 style="font-size: 24px; margin-bottom: 16px;">Failed to Load Dashboard Data</h1>
              <p style="color: #94a3b8;">Error: ${error.message}</p>
              <p style="color: #64748b; margin-top: 8px;">Please ensure data/dashboard_data.json exists and is accessible.</p>
            </div>
          </div>
        `;
      }
    }

    // Tooltip functions
    function showTooltip(event, content) {
      const tooltip = document.getElementById('chart-tooltip');
      const tooltipContent = document.getElementById('tooltip-content');

      tooltipContent.innerHTML = content;
      tooltip.classList.remove('hidden');

      // Position tooltip near mouse cursor
      const svg = document.getElementById('main-chart');
      const svgRect = svg.getBoundingClientRect();
      const x = event.clientX - svgRect.left;
      const y = event.clientY - svgRect.top;

      tooltip.style.left = `${x + 10}px`;
      tooltip.style.top = `${y - 10}px`;
    }

    function hideTooltip() {
      const tooltip = document.getElementById('chart-tooltip');
      tooltip.classList.add('hidden');
    }

    // Populate outliers with real data
    function populateOutliers() {
      // Get filtered year range
      const startYear = parseInt(document.getElementById('startYearValue').textContent);
      const endYear = parseInt(document.getElementById('endYearValue').textContent);

      const stats = dashboardData.statistics.by_year;
      const weather = dashboardData.weather.by_year;
      const overallMedian = dashboardData.statistics.overall.overall_median_minutes;

      // Calculate percent difference from overall median for each year (filtered by year range)
      const yearData = stats
        .filter(yearStats => yearStats.year >= startYear && yearStats.year <= endYear)
        .map((yearStats, idx) => {
          const medianMinutes = yearStats.times.median;
          const pctDiff = ((medianMinutes - overallMedian) / overallMedian) * 100;
          // Find the correct weather index for this year
          const weatherIdx = weather.findIndex(w => w.year === yearStats.year);
          const wind = weatherIdx >= 0 ? (weather[weatherIdx]?.summit?.wind_speed_avg || 0) : 0;

          return {
            year: yearStats.year,
            pctDiff: pctDiff,
            wind: wind,
            windLabel: wind > 10 ? 'high wind' : wind < 3 ? 'calm' : 'moderate wind'
          };
        });

      // Sort by absolute percent difference to find outliers
      const sortedByDiff = [...yearData].sort((a, b) => Math.abs(b.pctDiff) - Math.abs(a.pctDiff));

      // Take top 3 outliers (or fewer if filtered range has fewer years)
      const topOutliers = sortedByDiff.slice(0, Math.min(3, sortedByDiff.length));

      // Populate the list
      const outliersList = document.getElementById('outliers-list');
      outliersList.innerHTML = '';

      topOutliers.forEach(outlier => {
        const li = document.createElement('li');
        li.className = 'py-2 flex items-center justify-between text-sm';

        const pctSign = outlier.pctDiff >= 0 ? '+' : '';
        const colorClass = outlier.pctDiff >= 0 ? 'text-rose-400' : 'text-emerald-400';

        li.innerHTML = `
          <span class="text-slate-400">${outlier.year} (${outlier.windLabel})</span>
          <span class="font-medium tabular-nums ${colorClass}">${pctSign}${outlier.pctDiff.toFixed(1)}%</span>
        `;

        outliersList.appendChild(li);
      });
    }

    // Populate YoY Delta metrics
    function populateYoYMetrics() {
      const stats = dashboardData.statistics.by_year;

      if (stats.length < 2) {
        // Not enough data for YoY calculations
        document.getElementById('yoy-last-year').textContent = 'N/A';
        document.getElementById('yoy-avg-change').textContent = 'N/A';
        document.getElementById('yoy-volatility').textContent = 'N/A';
        return;
      }

      // Calculate YoY changes in median time
      const yoyChanges = [];
      for (let i = 1; i < stats.length; i++) {
        const prevMedian = stats[i - 1].times.median;
        const currMedian = stats[i].times.median;
        const pctChange = ((currMedian - prevMedian) / prevMedian) * 100;
        yoyChanges.push(pctChange);
      }

      // Last year vs prior (most recent YoY change)
      const lastYoYChange = yoyChanges[yoyChanges.length - 1];
      const lastYoYElement = document.getElementById('yoy-last-year');
      const lastYoYFormatted = `${lastYoYChange >= 0 ? '+' : ''}${lastYoYChange.toFixed(1)}%`;
      lastYoYElement.textContent = lastYoYFormatted;
      lastYoYElement.className = `font-medium tabular-nums ${lastYoYChange < 0 ? 'text-emerald-400' : 'text-rose-400'}`;

      // Average annual change
      const avgChange = yoyChanges.reduce((sum, val) => sum + val, 0) / yoyChanges.length;
      const avgChangeElement = document.getElementById('yoy-avg-change');
      const avgChangeFormatted = `${avgChange >= 0 ? '+' : ''}${avgChange.toFixed(1)}%`;
      avgChangeElement.textContent = avgChangeFormatted;
      avgChangeElement.className = `font-medium tabular-nums ${avgChange < 0 ? 'text-emerald-400' : 'text-slate-200'}`;

      // Volatility (standard deviation of YoY changes)
      const mean = avgChange;
      const squaredDiffs = yoyChanges.map(val => Math.pow(val - mean, 2));
      const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / yoyChanges.length;
      const stdDev = Math.sqrt(variance);
      document.getElementById('yoy-volatility').textContent = `σ = ${stdDev.toFixed(1)}%`;
    }

    // Initialize on page load
    function loadData() {
      populateKPIs();
      populateYearDropdowns();
      populateOutliers();
      populateYoYMetrics();
      renderChart();
    }

    // Populate KPI cards
    function populateKPIs() {
      const stats = dashboardData.statistics.overall;
      document.getElementById('kpi-fastest-year').textContent = `${stats.fastest_year_by_median} / ${stats.fastest_year_by_winner}`;
      document.getElementById('kpi-fastest-pct').textContent = `Median / Winner`;
      document.getElementById('kpi-wind-corr').textContent = `r = ${stats.wind_correlation || 'N/A'}`;
      document.getElementById('kpi-median-time').textContent = stats.overall_median_formatted;
      document.getElementById('kpi-fastest-time').textContent = `Fastest: ${stats.fastest_time}`;
      document.getElementById('kpi-total-years').textContent = `${stats.total_years} yrs`;
      document.getElementById('kpi-year-range').textContent = stats.year_range;
      document.getElementById('filter-wind-corr').textContent = `r = ${stats.wind_correlation || 'N/A'}`;
    }

    // Populate year dropdowns
    function populateYearDropdowns() {
      const years = dashboardData.years;
      const startList = document.getElementById('startYearList');
      const endList = document.getElementById('endYearList');

      years.forEach(y => {
        const liStart = document.createElement('li');
        liStart.innerHTML = `<button data-select="startYear" class="w-full text-left px-3 py-2 text-sm hover:bg-slate-950">${y}</button>`;
        startList.appendChild(liStart);
        const liEnd = document.createElement('li');
        liEnd.innerHTML = `<button data-select="endYear" class="w-full text-left px-3 py-2 text-sm hover:bg-slate-950">${y}</button>`;
        endList.appendChild(liEnd);
      });

      // Set initial values
      document.getElementById('startYearValue').textContent = years[0];
      document.getElementById('endYearValue').textContent = years[years.length - 1];
    }

    // Render main chart
    function renderChart() {
      const svg = document.getElementById('main-chart');
      svg.innerHTML = '';

      // Chart dimensions and scales
      const width = 960;
      const height = 550; // Increased to accommodate total riders row
      const marginLeft = 60;
      const marginRight = 40;
      const marginTop = 30;
      const marginBottom = 150; // Increased to accommodate wind data and total riders
      const chartWidth = width - marginLeft - marginRight;
      const chartHeight = height - marginTop - marginBottom;

      // Get filtered data
      const startYear = parseInt(document.getElementById('startYearValue').textContent);
      const endYear = parseInt(document.getElementById('endYearValue').textContent);
      const filteredData = dashboardData.statistics.by_year.filter(d => d.year >= startYear && d.year <= endYear);
      const filteredWeather = dashboardData.weather.by_year.filter(d => d.year >= startYear && d.year <= endYear);

      // Fixed Y-axis range: 40 to 100 minutes
      const minTime = 40;
      const maxTime = 100;

      // Y scale (INVERTED: faster times at TOP, slower times at BOTTOM)
      // Lower minutes value = faster = should be HIGHER on chart (SMALLER Y coordinate)
      const yScale = (minutes) => {
        // Normalize: 0 = minTime (fastest), 1 = maxTime (slowest)
        const normalized = (minutes - minTime) / (maxTime - minTime);
        // Map to Y coordinates: fastest (0) -> top (marginTop), slowest (1) -> bottom (marginTop + chartHeight)
        return marginTop + normalized * chartHeight;
      };

      // X scale
      const xSpacing = chartWidth / (filteredData.length + 1);
      const xScale = (index) => marginLeft + (index + 1) * xSpacing;

      // Add grid pattern
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      const pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
      pattern.setAttribute('id', 'grid');
      pattern.setAttribute('width', '80');
      pattern.setAttribute('height', '60');
      pattern.setAttribute('patternUnits', 'userSpaceOnUse');
      const gridPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      gridPath.setAttribute('d', 'M 80 0 L 0 0 0 60');
      gridPath.setAttribute('fill', 'none');
      gridPath.setAttribute('stroke', '#1f293b');
      gridPath.setAttribute('stroke-width', '1');
      pattern.appendChild(gridPath);
      defs.appendChild(pattern);
      svg.appendChild(defs);

      // Add grid background
      const gridRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      gridRect.setAttribute('x', '0');
      gridRect.setAttribute('y', '0');
      gridRect.setAttribute('width', width);
      gridRect.setAttribute('height', height);
      gridRect.setAttribute('fill', 'url(#grid)');
      svg.appendChild(gridRect);

      // Y-axis labels (clean 10-minute intervals: 40, 50, 60, 70, 80, 90, 100)
      const yAxisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      yAxisGroup.setAttribute('class', 'text-[11px] fill-slate-400');
      const yValues = [40, 50, 60, 70, 80, 90, 100];
      yValues.forEach(minutes => {
        const y = yScale(minutes);
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', '6');
        text.setAttribute('y', y + 4);
        text.textContent = `${minutes}:00`;
        yAxisGroup.appendChild(text);
      });
      svg.appendChild(yAxisGroup);

      // X-axis labels (years)
      const xAxisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      xAxisGroup.setAttribute('class', 'text-[12px] fill-slate-400');
      filteredData.forEach((d, i) => {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', xScale(i));
        text.setAttribute('y', marginTop + chartHeight + 15);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('font-weight', '600');
        text.textContent = d.year;
        xAxisGroup.appendChild(text);
      });
      svg.appendChild(xAxisGroup);

      // Wind data section
      const windDataGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      windDataGroup.setAttribute('class', 'text-[10px] fill-slate-400');

      // Headers for wind data
      const windHeaders = [
        { label: 'Wind @ Base:', y: marginTop + chartHeight + 35, color: '#94a3b8' },
        { label: 'Wind @ Summit:', y: marginTop + chartHeight + 50, color: '#94a3b8' },
        { label: 'Average Wind:', y: marginTop + chartHeight + 65, color: '#0ea5e9' },
        { label: 'Total Riders:', y: marginTop + chartHeight + 110, color: '#10b981' }
      ];

      windHeaders.forEach(header => {
        const headerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        headerText.setAttribute('x', marginLeft - 5);
        headerText.setAttribute('y', header.y);
        headerText.setAttribute('text-anchor', 'end');
        headerText.setAttribute('font-weight', header.color === '#0ea5e9' ? '600' : '500');
        headerText.setAttribute('fill', header.color);
        headerText.textContent = header.label;
        windDataGroup.appendChild(headerText);
      });

      // Wind data values for each year
      filteredWeather.forEach((w, i) => {
        const x = xScale(i);

        // Wind at base (start)
        const baseWind = w.start && w.start.wind_speed_avg ? w.start.wind_speed_avg.toFixed(1) : 'N/A';
        const baseDir = w.start && w.start.wind_direction_avg !== null ? w.start.wind_direction_avg : null;

        const baseText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        baseText.setAttribute('x', x - 8);
        baseText.setAttribute('y', marginTop + chartHeight + 35);
        baseText.setAttribute('text-anchor', 'middle');
        baseText.setAttribute('fill', '#94a3b8');
        baseText.textContent = `${baseWind} mph`;
        windDataGroup.appendChild(baseText);

        // Small arrow for base wind direction (to the right of text)
        if (baseDir !== null) {
          const smallArrowSize = 5;
          const baseArrowGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          // Add 180° to show direction wind is blowing TO (not FROM)
          baseArrowGroup.setAttribute('transform', `translate(${x + 18}, ${marginTop + chartHeight + 32}) rotate(${(baseDir + 180) % 360})`);

          const baseShaft = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          baseShaft.setAttribute('x1', '0');
          baseShaft.setAttribute('y1', smallArrowSize);
          baseShaft.setAttribute('x2', '0');
          baseShaft.setAttribute('y2', '-1');
          baseShaft.setAttribute('stroke', '#94a3b8');
          baseShaft.setAttribute('stroke-width', '1.5');
          baseArrowGroup.appendChild(baseShaft);

          const baseArrowHead = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
          baseArrowHead.setAttribute('points', `0,-${smallArrowSize} -${smallArrowSize/2},0 ${smallArrowSize/2},0`);
          baseArrowHead.setAttribute('fill', '#94a3b8');
          baseArrowGroup.appendChild(baseArrowHead);

          windDataGroup.appendChild(baseArrowGroup);
        }

        // Wind at summit
        const summitWind = w.summit && w.summit.wind_speed_avg ? w.summit.wind_speed_avg.toFixed(1) : 'N/A';
        const summitDir = w.summit && w.summit.wind_direction_avg !== null ? w.summit.wind_direction_avg : null;

        const summitText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        summitText.setAttribute('x', x - 8);
        summitText.setAttribute('y', marginTop + chartHeight + 50);
        summitText.setAttribute('text-anchor', 'middle');
        summitText.setAttribute('fill', '#94a3b8');
        summitText.textContent = `${summitWind} mph`;
        windDataGroup.appendChild(summitText);

        // Small arrow for summit wind direction (to the right of text)
        if (summitDir !== null) {
          const smallArrowSize = 5;
          const summitArrowGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          // Add 180° to show direction wind is blowing TO (not FROM)
          summitArrowGroup.setAttribute('transform', `translate(${x + 18}, ${marginTop + chartHeight + 47}) rotate(${(summitDir + 180) % 360})`);

          const summitShaft = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          summitShaft.setAttribute('x1', '0');
          summitShaft.setAttribute('y1', smallArrowSize);
          summitShaft.setAttribute('x2', '0');
          summitShaft.setAttribute('y2', '-1');
          summitShaft.setAttribute('stroke', '#94a3b8');
          summitShaft.setAttribute('stroke-width', '1.5');
          summitArrowGroup.appendChild(summitShaft);

          const summitArrowHead = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
          summitArrowHead.setAttribute('points', `0,-${smallArrowSize} -${smallArrowSize/2},0 ${smallArrowSize/2},0`);
          summitArrowHead.setAttribute('fill', '#94a3b8');
          summitArrowGroup.appendChild(summitArrowHead);

          windDataGroup.appendChild(summitArrowGroup);
        }

        // Average wind (average of base and summit)
        const avgWind = (w.start && w.summit && w.start.wind_speed_avg && w.summit.wind_speed_avg)
          ? ((w.start.wind_speed_avg + w.summit.wind_speed_avg) / 2).toFixed(1)
          : 'N/A';
        const avgText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        avgText.setAttribute('x', x);
        avgText.setAttribute('y', marginTop + chartHeight + 65);
        avgText.setAttribute('text-anchor', 'middle');
        avgText.setAttribute('fill', '#0ea5e9');
        avgText.setAttribute('font-weight', '600');
        avgText.textContent = `${avgWind} mph`;
        windDataGroup.appendChild(avgText);

        // Wind direction arrow (average of base and summit directions) - larger arrow below
        if (baseDir !== null && summitDir !== null) {
          // Average the two directions (handling circular nature of degrees)
          const avgDir = ((baseDir + summitDir) / 2) % 360;

          // Create arrow pointing in direction wind is blowing TO (push direction)
          // Add 180° because meteorological direction is where wind comes FROM
          const arrowY = marginTop + chartHeight + 80;
          const arrowSize = 8;

          // Create a group for the arrow to apply rotation
          const arrowGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          arrowGroup.setAttribute('transform', `translate(${x}, ${arrowY}) rotate(${(avgDir + 180) % 360})`);

          // Arrow shaft (vertical line pointing up in default orientation)
          const shaft = document.createElementNS('http://www.w3.org/2000/svg', 'line');
          shaft.setAttribute('x1', '0');
          shaft.setAttribute('y1', arrowSize);
          shaft.setAttribute('x2', '0');
          shaft.setAttribute('y2', '-2');
          shaft.setAttribute('stroke', '#0ea5e9');
          shaft.setAttribute('stroke-width', '2');
          arrowGroup.appendChild(shaft);

          // Arrow head (triangle pointing up)
          const arrowHead = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
          arrowHead.setAttribute('points', `0,-${arrowSize} -${arrowSize/2},0 ${arrowSize/2},0`);
          arrowHead.setAttribute('fill', '#0ea5e9');
          arrowGroup.appendChild(arrowHead);

          windDataGroup.appendChild(arrowGroup);
        }

        // Total riders count for this year
        const riderCount = filteredData[i] ? filteredData[i].count : 'N/A';
        const ridersText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        ridersText.setAttribute('x', x);
        ridersText.setAttribute('y', marginTop + chartHeight + 110);
        ridersText.setAttribute('text-anchor', 'middle');
        ridersText.setAttribute('fill', '#10b981');
        ridersText.setAttribute('font-weight', '600');
        ridersText.textContent = riderCount;
        windDataGroup.appendChild(ridersText);
      });

      svg.appendChild(windDataGroup);

      // Weather layer (wind overlay) - context-aware coloring
      const weatherLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      weatherLayer.setAttribute('id', 'layer-wind');
      weatherLayer.setAttribute('opacity', '1');

      // Add wind speed indicators for each year
      filteredWeather.forEach((w, i) => {
        if (w.summit && w.summit.wind_speed_avg) {
          const windSpeed = w.summit.wind_speed_avg;
          const windDirection = w.summit.wind_direction_avg;

          let fillColor, opacity;

          if (routeData && windDirection !== null) {
            // Context-aware coloring based on wind impact
            const impact = calculateWindImpact(windDirection, routeData);

            // Base opacity on wind speed
            const baseOpacity = Math.min(0.4, windSpeed / 30);

            if (impact.impact === 'beneficial') {
              // Green for tailwind
              fillColor = `rgba(34, 197, 94, ${baseOpacity})`;
            } else if (impact.impact === 'detrimental') {
              // Red for headwind
              fillColor = `rgba(239, 68, 68, ${baseOpacity})`;
            } else {
              // Orange/yellow for crosswind
              fillColor = `rgba(251, 191, 36, ${baseOpacity})`;
            }
            opacity = 1;
          } else {
            // Fallback to blue if no route data
            const baseOpacity = Math.min(0.3, windSpeed / 40);
            fillColor = `rgba(14, 165, 233, ${baseOpacity})`;
            opacity = 1;
          }

          const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          rect.setAttribute('x', xScale(i) - xSpacing/3);
          rect.setAttribute('y', marginTop);
          rect.setAttribute('width', xSpacing * 0.66);
          rect.setAttribute('height', chartHeight);
          rect.setAttribute('fill', fillColor);
          rect.setAttribute('opacity', opacity);
          weatherLayer.appendChild(rect);
        }
      });
      svg.appendChild(weatherLayer);

      // Box plot layer
      const boxPlotLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      boxPlotLayer.setAttribute('id', 'layer-boxplot');

      filteredData.forEach((d, i) => {
        const x = xScale(i);
        const boxWidth = Math.min(20, xSpacing * 0.4);

        // Draw box (25th to 75th percentile)
        // p25 is FASTER (lower number) so should be HIGHER (smaller Y)
        // p75 is SLOWER (higher number) so should be LOWER (larger Y)
        const box = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        box.setAttribute('x', x - boxWidth/2);
        box.setAttribute('y', yScale(d.times.p25)); // Start at p25 (faster, at top)
        box.setAttribute('width', boxWidth);
        box.setAttribute('height', yScale(d.times.p75) - yScale(d.times.p25)); // Height to p75 (slower, at bottom)
        box.setAttribute('fill', '#94a3b814');
        box.setAttribute('stroke', '#64748b');
        box.setAttribute('stroke-width', '1');
        box.setAttribute('cursor', 'pointer');
        box.addEventListener('mouseenter', (e) => showTooltip(e, `
          <strong class="text-slate-100">${d.year} IQR</strong><br/>
          25th percentile: ${d.times_formatted.p25}<br/>
          75th percentile: ${d.times_formatted.p75}
        `));
        box.addEventListener('mouseleave', hideTooltip);
        boxPlotLayer.appendChild(box);

        // Draw 25th percentile marker (top of box)
        const p25Marker = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        p25Marker.setAttribute('x1', x - boxWidth/2);
        p25Marker.setAttribute('y1', yScale(d.times.p25));
        p25Marker.setAttribute('x2', x + boxWidth/2);
        p25Marker.setAttribute('y2', yScale(d.times.p25));
        p25Marker.setAttribute('stroke', '#64748b');
        p25Marker.setAttribute('stroke-width', '1.5');
        p25Marker.setAttribute('cursor', 'pointer');
        p25Marker.addEventListener('mouseenter', (e) => showTooltip(e, `
          <strong class="text-slate-100">${d.year} 25th Percentile</strong><br/>
          ${d.times_formatted.p25}
        `));
        p25Marker.addEventListener('mouseleave', hideTooltip);
        boxPlotLayer.appendChild(p25Marker);

        // Draw 75th percentile marker (bottom of box)
        const p75Marker = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        p75Marker.setAttribute('x1', x - boxWidth/2);
        p75Marker.setAttribute('y1', yScale(d.times.p75));
        p75Marker.setAttribute('x2', x + boxWidth/2);
        p75Marker.setAttribute('y2', yScale(d.times.p75));
        p75Marker.setAttribute('stroke', '#64748b');
        p75Marker.setAttribute('stroke-width', '1.5');
        p75Marker.setAttribute('cursor', 'pointer');
        p75Marker.addEventListener('mouseenter', (e) => showTooltip(e, `
          <strong class="text-slate-100">${d.year} 75th Percentile</strong><br/>
          ${d.times_formatted.p75}
        `));
        p75Marker.addEventListener('mouseleave', hideTooltip);
        boxPlotLayer.appendChild(p75Marker);

        // Draw median line with triangle markers
        const medianLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        medianLine.setAttribute('x1', x - boxWidth/2);
        medianLine.setAttribute('y1', yScale(d.times.median));
        medianLine.setAttribute('x2', x + boxWidth/2);
        medianLine.setAttribute('y2', yScale(d.times.median));
        medianLine.setAttribute('stroke', '#0f766e');
        medianLine.setAttribute('stroke-width', '2');
        medianLine.setAttribute('cursor', 'pointer');
        medianLine.addEventListener('mouseenter', (e) => showTooltip(e, `
          <strong class="text-slate-100">${d.year} Median</strong><br/>
          ${d.times_formatted.median}
        `));
        medianLine.addEventListener('mouseleave', hideTooltip);
        boxPlotLayer.appendChild(medianLine);

        // Draw median triangle markers (left and right)
        const medianTriangleLeft = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        const triangleSize = 3;
        const medianY = yScale(d.times.median);
        const leftX = x - boxWidth/2;
        medianTriangleLeft.setAttribute('points', `${leftX},${medianY} ${leftX-triangleSize},${medianY-triangleSize} ${leftX-triangleSize},${medianY+triangleSize}`);
        medianTriangleLeft.setAttribute('fill', '#0f766e');
        medianTriangleLeft.setAttribute('cursor', 'pointer');
        medianTriangleLeft.addEventListener('mouseenter', (e) => showTooltip(e, `
          <strong class="text-slate-100">${d.year} Median</strong><br/>
          ${d.times_formatted.median}
        `));
        medianTriangleLeft.addEventListener('mouseleave', hideTooltip);
        boxPlotLayer.appendChild(medianTriangleLeft);

        const medianTriangleRight = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        const rightX = x + boxWidth/2;
        medianTriangleRight.setAttribute('points', `${rightX},${medianY} ${rightX+triangleSize},${medianY-triangleSize} ${rightX+triangleSize},${medianY+triangleSize}`);
        medianTriangleRight.setAttribute('fill', '#0f766e');
        medianTriangleRight.setAttribute('cursor', 'pointer');
        medianTriangleRight.addEventListener('mouseenter', (e) => showTooltip(e, `
          <strong class="text-slate-100">${d.year} Median</strong><br/>
          ${d.times_formatted.median}
        `));
        medianTriangleRight.addEventListener('mouseleave', hideTooltip);
        boxPlotLayer.appendChild(medianTriangleRight);

        // Draw mean dot (larger)
        const meanDot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        meanDot.setAttribute('cx', x);
        meanDot.setAttribute('cy', yScale(d.times.mean));
        meanDot.setAttribute('r', '4.5');
        meanDot.setAttribute('fill', '#6366f1');
        meanDot.setAttribute('cursor', 'pointer');
        meanDot.addEventListener('mouseenter', (e) => showTooltip(e, `
          <strong class="text-slate-100">${d.year} Mean</strong><br/>
          ${d.times_formatted.mean}
        `));
        meanDot.addEventListener('mouseleave', hideTooltip);
        boxPlotLayer.appendChild(meanDot);

        // Calculate 10th percentile (top 10% of finishers)
        const p10Time = d.times.p25 - (d.times.p25 - d.times.min) * 0.6; // Approximate between min and p25
        const p10Formatted = `${Math.floor(p10Time)}:${String(Math.round((p10Time % 1) * 60)).padStart(2, '0')}`;

        // Draw line from 10th percentile to fastest time (red, dashed) - FIRST so it's under the dots
        const p10ToMinLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        p10ToMinLine.setAttribute('x1', x);
        p10ToMinLine.setAttribute('y1', yScale(p10Time));
        p10ToMinLine.setAttribute('x2', x);
        p10ToMinLine.setAttribute('y2', yScale(d.times.min));
        p10ToMinLine.setAttribute('stroke', '#ef4444');
        p10ToMinLine.setAttribute('stroke-width', '1.5');
        p10ToMinLine.setAttribute('stroke-dasharray', '3,3');
        p10ToMinLine.setAttribute('opacity', '0.8');
        boxPlotLayer.appendChild(p10ToMinLine);

        // Draw line from 25th percentile to 10th percentile (yellow, dashed) - SECOND so it's under the dots
        const p25ToP10Line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        p25ToP10Line.setAttribute('x1', x);
        p25ToP10Line.setAttribute('y1', yScale(d.times.p25));
        p25ToP10Line.setAttribute('x2', x);
        p25ToP10Line.setAttribute('y2', yScale(p10Time));
        p25ToP10Line.setAttribute('stroke', '#eab308');
        p25ToP10Line.setAttribute('stroke-width', '1.5');
        p25ToP10Line.setAttribute('stroke-dasharray', '3,3');
        p25ToP10Line.setAttribute('opacity', '0.8');
        boxPlotLayer.appendChild(p25ToP10Line);

        // Draw 10th percentile dot (yellow) - THIRD so it's on top of lines
        const p10Dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        p10Dot.setAttribute('cx', x);
        p10Dot.setAttribute('cy', yScale(p10Time));
        p10Dot.setAttribute('r', '4.5');
        p10Dot.setAttribute('fill', '#eab308');
        p10Dot.setAttribute('cursor', 'pointer');
        p10Dot.addEventListener('mouseenter', (e) => showTooltip(e, `
          <strong class="text-slate-100">${d.year} 10th Percentile</strong><br/>
          Top 10% of finishers<br/>
          ${p10Formatted}
        `));
        p10Dot.addEventListener('mouseleave', hideTooltip);
        boxPlotLayer.appendChild(p10Dot);

        // Draw fastest time dot (larger)
        const fastestDot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        fastestDot.setAttribute('cx', x);
        fastestDot.setAttribute('cy', yScale(d.times.min));
        fastestDot.setAttribute('r', '4.5');
        fastestDot.setAttribute('fill', '#ef4444');
        fastestDot.setAttribute('cursor', 'pointer');
        fastestDot.addEventListener('mouseenter', (e) => showTooltip(e, `
          <strong class="text-slate-100">${d.year} Fastest Time</strong><br/>
          ${d.times_formatted.min}
        `));
        fastestDot.addEventListener('mouseleave', hideTooltip);
        boxPlotLayer.appendChild(fastestDot);
      });

      svg.appendChild(boxPlotLayer);

      // Multi-year rider stars layer (only for selected rider)
      const multiYearRidersLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      multiYearRidersLayer.setAttribute('id', 'layer-multi-year-riders');

      // Only draw stars if a rider is selected
      if (selectedRider) {
        // Draw gold stars for selected rider's performances in filtered years
        filteredData.forEach((d, i) => {
          const x = xScale(i);
          const year = d.year;

          // Find this rider's performance for this year
          const performance = selectedRider.performances.find(p => p.year === year);

          if (performance) {
            const timeMinutes = performance.time_seconds / 60;
            const y = yScale(timeMinutes);

            // Create gold star (unicode star character)
            const star = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            star.setAttribute('x', x);
            star.setAttribute('y', y + 1);
            star.setAttribute('text-anchor', 'middle');
            star.setAttribute('font-size', '14');
            star.setAttribute('fill', '#fbbf24');
            star.setAttribute('cursor', 'pointer');
            star.setAttribute('class', 'star-marker');
            star.textContent = '★';

            star.addEventListener('mouseenter', (e) => showTooltip(e, `
              <strong class="text-amber-400">★ ${selectedRider.name}</strong><br/>
              ${year}: ${performance.time_formatted} (Place ${performance.place})
            `));
            star.addEventListener('mouseleave', hideTooltip);

            multiYearRidersLayer.appendChild(star);
          }
        });
      }

      svg.appendChild(multiYearRidersLayer);

      // Median trend line connecting all years
      const medianLineLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      medianLineLayer.setAttribute('id', 'layer-median-line');

      // Build path data for median line
      let pathData = '';
      filteredData.forEach((d, i) => {
        const x = xScale(i);
        const y = yScale(d.times.median);
        if (i === 0) {
          pathData += `M ${x} ${y}`;
        } else {
          pathData += ` L ${x} ${y}`;
        }
      });

      const medianPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      medianPath.setAttribute('d', pathData);
      medianPath.setAttribute('fill', 'none');
      medianPath.setAttribute('stroke', '#0f766e');
      medianPath.setAttribute('stroke-width', '2.5');
      medianPath.setAttribute('stroke-linejoin', 'round');
      medianLineLayer.appendChild(medianPath);

      svg.appendChild(medianLineLayer);

      // 1-hour cutoff reference line
      const cutoffLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      cutoffLayer.setAttribute('id', 'layer-cutoff');

      const cutoffY = yScale(60); // 60 minutes = 1 hour

      // Solid line
      const cutoffLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      cutoffLine.setAttribute('x1', marginLeft);
      cutoffLine.setAttribute('y1', cutoffY);
      cutoffLine.setAttribute('x2', width - marginRight);
      cutoffLine.setAttribute('y2', cutoffY);
      cutoffLine.setAttribute('stroke', '#64748b');
      cutoffLine.setAttribute('stroke-width', '1.5');
      cutoffLine.setAttribute('opacity', '0.6');
      cutoffLayer.appendChild(cutoffLine);

      // Label
      const cutoffLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      cutoffLabel.setAttribute('x', width - marginRight + 5);
      cutoffLabel.setAttribute('y', cutoffY + 4);
      cutoffLabel.setAttribute('class', 'text-[11px] fill-slate-400');
      cutoffLabel.setAttribute('font-weight', '500');
      cutoffLabel.textContent = '1 hour cutoff';
      cutoffLayer.appendChild(cutoffLabel);

      svg.appendChild(cutoffLayer);
    }

    // Show rider performance in modal
    function showRiderPerformance(rider) {
      // Set selected rider and re-render chart to show stars
      selectedRider = rider;
      renderChart();

      const riderModal = document.getElementById('riderModal');
      const riderModalName = document.getElementById('riderModalName');
      const riderModalContent = document.getElementById('riderModalContent');

      // Set rider name
      riderModalName.textContent = rider.name;

      // Calculate year-over-year changes
      const performances = rider.performances;
      const yoyChanges = [];

      for (let i = 1; i < performances.length; i++) {
        const prevPerf = performances[i - 1];
        const currPerf = performances[i];
        const timeDiff = currPerf.time_seconds - prevPerf.time_seconds;
        const pctChange = (timeDiff / prevPerf.time_seconds) * 100;

        // Get pack median for both years
        const prevYearStats = dashboardData.statistics.by_year.find(y => y.year === prevPerf.year);
        const currYearStats = dashboardData.statistics.by_year.find(y => y.year === currPerf.year);

        const prevPackMedian = prevYearStats ? prevYearStats.times.median * 60 : null;
        const currPackMedian = currYearStats ? currYearStats.times.median * 60 : null;

        const packTimeDiff = currPackMedian && prevPackMedian ? currPackMedian - prevPackMedian : null;
        const packPctChange = packTimeDiff && prevPackMedian ? (packTimeDiff / prevPackMedian) * 100 : null;

        const vsPackDiff = packPctChange !== null ? pctChange - packPctChange : null;

        yoyChanges.push({
          fromYear: prevPerf.year,
          toYear: currPerf.year,
          riderChange: pctChange,
          packChange: packPctChange,
          vsPackDiff: vsPackDiff,
          riderTimeChange: timeDiff
        });
      }

      // Build modal content
      let content = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="rounded-lg border p-4 border-slate-800 bg-black">
            <div class="text-xs uppercase tracking-wide text-slate-500 mb-2">Participation History</div>
            <div class="space-y-2">
              ${performances.map(perf => `
                <div class="flex items-center justify-between text-sm">
                  <span class="text-slate-400">${perf.year}</span>
                  <div class="text-right">
                    <div class="text-slate-200 font-medium">${perf.time_formatted}</div>
                    <div class="text-slate-500 text-xs">Place ${perf.place}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="rounded-lg border p-4 border-slate-800 bg-black">
            <div class="text-xs uppercase tracking-wide text-slate-500 mb-2">Summary Stats</div>
            <div class="space-y-2 text-sm">
              <div class="flex items-center justify-between">
                <span class="text-slate-400">Years participated</span>
                <span class="text-slate-200 font-medium">${rider.years_participated}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-slate-400">Best time</span>
                <span class="text-slate-200 font-medium">${performances.reduce((best, p) => p.time_seconds < best.time_seconds ? p : best).time_formatted}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-slate-400">Best place</span>
                <span class="text-slate-200 font-medium">${Math.min(...performances.map(p => p.place))}</span>
              </div>
            </div>
          </div>
        </div>
      `;

      if (yoyChanges.length > 0) {
        content += `
          <div class="mt-4">
            <div class="text-sm font-medium text-slate-200 mb-3">Year-over-Year Performance</div>
            <div class="space-y-3">
              ${yoyChanges.map(change => {
                const riderColor = change.riderChange < 0 ? 'text-emerald-400' : 'text-rose-400';
                const packColor = change.packChange < 0 ? 'text-emerald-400' : 'text-rose-400';
                const vsPackColor = change.vsPackDiff < 0 ? 'text-emerald-400' : 'text-rose-400';
                const riderSign = change.riderChange >= 0 ? '+' : '';
                const packSign = change.packChange >= 0 ? '+' : '';
                const vsPackSign = change.vsPackDiff >= 0 ? '+' : '';

                return `
                  <div class="rounded-lg border p-4 border-slate-800">
                    <div class="text-sm font-medium text-slate-300 mb-3">${change.fromYear} → ${change.toYear}</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                      <div>
                        <div class="text-slate-500 text-xs mb-1">Rider Change</div>
                        <div class="${riderColor} font-medium tabular-nums">${riderSign}${change.riderChange.toFixed(1)}%</div>
                        <div class="text-slate-500 text-xs">${riderSign}${change.riderTimeChange.toFixed(0)}s</div>
                      </div>
                      <div>
                        <div class="text-slate-500 text-xs mb-1">Pack Median Change</div>
                        <div class="${packColor} font-medium tabular-nums">${packSign}${change.packChange.toFixed(1)}%</div>
                      </div>
                      <div>
                        <div class="text-slate-500 text-xs mb-1">vs Pack</div>
                        <div class="${vsPackColor} font-medium tabular-nums">${vsPackSign}${change.vsPackDiff.toFixed(1)}%</div>
                        <div class="text-slate-500 text-xs">${change.vsPackDiff < 0 ? 'Outperformed' : 'Underperformed'}</div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      riderModalContent.innerHTML = content;
      riderModal.classList.remove('hidden');
      lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
    }

    // Initialize icons and interactions
    document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });

      // Upload modal handlers
      const uploadModal = document.getElementById('uploadModal');
      const uploadButton = document.getElementById('uploadButton');
      const closeModal = document.getElementById('closeModal');

      uploadButton.addEventListener('click', () => {
        uploadModal.classList.remove('hidden');
        // Re-initialize lucide icons for the modal
        lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      });

      closeModal.addEventListener('click', () => {
        uploadModal.classList.add('hidden');
      });

      // Close modal when clicking outside
      uploadModal.addEventListener('click', (e) => {
        if (e.target === uploadModal) {
          uploadModal.classList.add('hidden');
        }
      });

      // Close modal on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !uploadModal.classList.contains('hidden')) {
          uploadModal.classList.add('hidden');
        }
        if (e.key === 'Escape' && !feedbackModal.classList.contains('hidden')) {
          feedbackModal.classList.add('hidden');
        }
        if (e.key === 'Escape' && !riderModal.classList.contains('hidden')) {
          closeRiderModalAndClearStars();
        }
      });

      // Feedback modal handlers
      const feedbackModal = document.getElementById('feedbackModal');
      const feedbackButton = document.getElementById('feedbackButton');
      const closeFeedbackModal = document.getElementById('closeFeedbackModal');

      feedbackButton.addEventListener('click', () => {
        feedbackModal.classList.remove('hidden');
        lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
      });

      closeFeedbackModal.addEventListener('click', () => {
        feedbackModal.classList.add('hidden');
      });

      feedbackModal.addEventListener('click', (e) => {
        if (e.target === feedbackModal) {
          feedbackModal.classList.add('hidden');
        }
      });

      // Rider modal handlers
      const riderModal = document.getElementById('riderModal');
      const closeRiderModal = document.getElementById('closeRiderModal');

      function closeRiderModalAndClearStars() {
        riderModal.classList.add('hidden');
        selectedRider = null; // Clear selected rider
        renderChart(); // Re-render chart to remove stars
      }

      closeRiderModal.addEventListener('click', closeRiderModalAndClearStars);

      riderModal.addEventListener('click', (e) => {
        if (e.target === riderModal) {
          closeRiderModalAndClearStars();
        }
      });

      // Rider search functionality
      const riderSearchInput = document.getElementById('riderSearch');
      const riderSearchResults = document.getElementById('riderSearchResults');

      riderSearchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();

        if (query.length < 2) {
          riderSearchResults.classList.add('hidden');
          return;
        }

        if (!dashboardData || !dashboardData.riders) {
          return;
        }

        // Filter riders by name
        const matches = dashboardData.riders.filter(rider =>
          rider.name.toLowerCase().includes(query)
        );

        if (matches.length === 0) {
          riderSearchResults.classList.add('hidden');
          return;
        }

        // Populate results dropdown
        riderSearchResults.innerHTML = '';
        matches.slice(0, 10).forEach(rider => {
          const li = document.createElement('div');
          li.className = 'px-3 py-2 text-sm hover:bg-slate-950 cursor-pointer border-b border-slate-800 last:border-b-0';
          li.innerHTML = `
            <div class="flex items-center justify-between">
              <div>
                <div class="text-slate-200 font-medium">${rider.name}</div>
                <div class="text-slate-500 text-xs">${rider.years_participated} years: ${rider.performances.map(p => p.year).join(', ')}</div>
              </div>
              <span class="text-amber-400">★</span>
            </div>
          `;
          li.addEventListener('click', () => {
            showRiderPerformance(rider);
            riderSearchResults.classList.add('hidden');
            riderSearchInput.value = '';
          });
          riderSearchResults.appendChild(li);
        });

        riderSearchResults.classList.remove('hidden');
      });

      // Close search results when clicking outside
      document.addEventListener('click', (e) => {
        if (!riderSearchInput.contains(e.target) && !riderSearchResults.contains(e.target)) {
          riderSearchResults.classList.add('hidden');
        }
      });

      // Fetch data first, then load dashboard
      await fetchDashboardData();
      routeData = await fetchAndParseGPX();

      if (dashboardData) {
        loadData();
      }

      if (routeData) {
        renderRouteCompass();
        renderWindBenefitBox();
      }

      // Wind layer toggle
      document.getElementById('toggle-wind').addEventListener('click', function() {
        const windLayer = document.getElementById('layer-wind');
        const pressed = this.getAttribute('aria-pressed') === 'true';

        // Toggle state
        this.setAttribute('aria-pressed', String(!pressed));

        // Toggle visibility
        if (windLayer) {
          windLayer.setAttribute('opacity', pressed ? '0' : '1');
        }

        // Toggle button styling
        if (pressed) {
          this.classList.remove('bg-sky-900');
        } else {
          this.classList.add('bg-sky-900');
        }
      });

      // Popovers
      function closeAllPopovers() {
        document.querySelectorAll('[data-popover]').forEach(p => p.classList.add('hidden'));
      }
      document.querySelectorAll('[data-popover-button]').forEach(btn => {
        const targetSel = btn.getAttribute('data-popover-button');
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const pop = document.querySelector(targetSel);
          const isOpen = pop && !pop.classList.contains('hidden');
          closeAllPopovers();
          if (pop && !isOpen) pop.classList.remove('hidden');
        });
      });
      document.addEventListener('click', closeAllPopovers);

      // Year selections
      function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      }

      document.addEventListener('click', (e) => {
        const t = e.target;
        if (!(t instanceof HTMLElement)) return;

        if (t.matches('[data-select="startYear"]')) {
          setText('startYearValue', t.textContent.trim());
          closeAllPopovers();
        }
        if (t.matches('[data-select="endYear"]')) {
          setText('endYearValue', t.textContent.trim());
          closeAllPopovers();
        }
      });

      // Apply filters - re-render chart and update outliers
      document.getElementById('applyFilters').addEventListener('click', () => {
        if (dashboardData) {
          renderChart();
          populateOutliers(); // Also update outliers based on filtered years
        }
      });

      // Reset filters
      document.getElementById('resetFilters').addEventListener('click', () => {
        if (dashboardData) {
          const years = dashboardData.years;
          setText('startYearValue', years[0]);
          setText('endYearValue', years[years.length - 1]);
          renderChart();
          populateOutliers(); // Also update outliers when resetting
        }
      });
    });
  </script>

</body></html>